# 주소 결정과 TCP/IP 주소 결정 프로토콜

네트워킹 프로토콜 스택을 가지고 있는 모든 장비는 2계층 주소와 3계층 주소 모두를 갖는다는 것을 의미한다.  
그래서 이들 주소를 서로 연결할 방법을 정의 하는 것은 매우 중요하다.  
이것은 네트워크 주소를 가지고 그에 해당하는 데이터 링크 계층 주소를 찾는 과정으로 이뤄지는데 이것을 주소 결정이라고 한다.  

1. TCP/IP 주소 결정 프로토콜을 자세히 설명한다.  
    1-1. 주소결정 프로토콜 (ARP)  
    1-2. 역순 주소 결정 프로토콜 (RARP)  
2. 주소 결정이 IP의 의 멀티캐스트 주소에서 어떻게 일어나는지 살펴본다.

## 주소 결정의 필요성

개념적으로 클라이언트와 서버가 3계층(IP)으로 직접 연결돼 있다 하더라도 실제로 그들이 주고 받는 정보는 여러 2계층(MAC) 링크를 통해 전송된다.
논리적으로 이 연결은 클라이언트와 서버 간에 직접 맺어질 수 있다. 하지만 사실 이 연결은 2계층 물리 링크 연결의 연속이다. 아래 그림에서 그러한 링크가 6개 있으며 그들의 대부분은 클라이언트와 서버 사이에 있는 라우터 간의 연결이다. 각 단계에서 데이터를 어디로 보낼지는 3계층 주소에 근거하여 결정되지만 실제 전송은 다음 경로에 있는 수신자의 2계층 주소를 통해 수행된다.  
![Why Address Resolution Is necessary!](http://www.tcpipguide.com/free/diagrams/arpresolutionneed.png)

근본적인 문제는 IP 주소가 네트워크의 물리적 하드웨어보다 너무 높은 수준에 있다는 것이다. 하드웨어는 IP 주소를 이해하지 못한다.
사용자의 요청이 목적지 서버가 연결된 라우터에 도달하면 그 라우터는 목적지 서버의 IP 주소를 볼 수 있다. 그렇지만 그것은 실제로 요청을 전달하는데 도움이 되지 못한다. 라우터는 서버의 MAC 주소로 요청을 보내야 하기 때문이다.
통신은 IP 계층에서 논리적으로 일어나지만 실제로는 데이터 링크 계층에서 수행 되어야 한다. 이것은 이들 두 계층의 주소를 변환하는 방법을 알아야 한다는 것을 의미한다. 그 절차를 주소 결정이라 부른다.  

> 주소 결정이 필요한 이유는 장비들이 논리적으로 3계층 주소로 통신하지만, 실제 물리적 통신을 2계층(하드웨어) 주소를 통해 수행하기 때문이다.

### 주소 결정 방법

- 직접 매핑
- 동적 매핑

#### 직접 매핑의 동작 방식

상위 계층 주소를 하위 계층 주소로 매핑한다.
예를 들면 2계층 하드웨어 주소 크기가 작다면 하드웨어 주소를 3계층 주소의 일부에 직접 정의패서 매핑하는 방식이다.  
![Address Resolution Through Direct Mapping!](http://www.tcpipguide.com/free/diagrams/arpdirectmapping.png)

#### 직접 매핑의 문제점

하드웨어 계층의 주소가 네트워크 계층 주소로 표현할 수 있을 때만 가능하다.
IP (네트워크) 주소는 32비트 이고 MAC(하드웨어) 주소는 48비트 이기 때문에 직접 매핑이 불가능 하다.  
![Address Resolution Problems With Large Hardware Address Size!](http://www.tcpipguide.com/free/diagrams/arpdirectmappingnogo.png)

#### 동적 매핑의 동작 방식

데이터를 보내고자 하는 장비가 다른 장비의 하드웨어 정보를 받고 싶다는 요청을 3계층 (네트워크) 주소 정보를 담아 브로드 캐스트 하면 본인의 3계층 (네트워크) 주소가 일치하는 장비가 응답을 보내는 방식이다. 단지 직접 매핑은 빠른 속도로 이뤄 지지만 동적 매핑은 네트워크로 메시지를 주고 받기 위해 프로토콜을 사용해야 한다.  
![Dynamic Address Resolution!](http://www.tcpipguide.com/free/diagrams/arpdynamic.png)

## TCP/IP 주소 결정 프로토콜 (ARP)

> IP 주소에 해당하는 데이터 링크 계층 주소(MAC)를 파악하는데 쓰이는 동적 결정 프로토콜  
> RFC 826 - 이더넷 주소 결정 프로토콜

이장에서 설명하는 주소 결정 프로토콜은 IPv4의 유니캐스트 주소를 변한하는데 쓰임
IPv6은 ARP 대신 주변 탐색 프로토콜을 사용한다.

### ARP 메시지 유형과 주소 표시

- 요청: 초기 요청에는 송신자는 출발지(전송할 IP 데이터 그램을 가지고 있는 장비) 장비 이고 수신자는 목적지 장비이다.
- 응답: ARP 요청에 대한 응답에서 송신자는 목적지 장비다. 그 응답은 출발지 장비에게 정송되며 그 장비가 수신자가 된다.  
모든 ARP의 메시지에서 두 장비는 서로 연관시켜야 할 두 주소(2계층과 3계층 주소)를 가지고 있다. 각 메시지에서 사용되는 4개의 서로 다른 주소는 다음과 같다.
- 송신자 하드웨어 주소: ARP 메시지 송신자의 2계층(MAC) 주소
- 송신자 프로토콜 주소: ARP 메시지 송신자의 3계층(IP) 주소
- 수신자 하드웨어 주소: ARP 메시지 송신자의 2계층(MAC) 주소
- 수신자 프로토콜 주소: ARP 메시지 송신자의 3계층(IP) 주소  
이들 주소는 각각 ARP 메시지 포맷에서 특정 위치를 차지한다.

### ARP 일반 동작

1. 출발지 장비가 캐시를 검사
2. 출발지 장비가 ARP 요청 메시지를 생성
3. 출발지 장비가 ARP 요청 메시지를 브로드캐스트
4. 로컬 장비들이 ARP 요청 메시지를 처리
5. 목적지 장비가 ARP 응답 메시지를 생성
6. 목적지 장비가 ARP 캐시를 갱신
7. 목적지 장비가 ARP 응답 메시지를 보냄
8. 출발지 장비가 ARP 응답 메시지를 처리
9. 출발지 장비가ARP 캐시를 갱신
![Address Resolution Protocol (ARP) Transaction Process!](http://www.tcpipguide.com/free/diagrams/arpoperation.png)

### ARP 메시지 포맷

| 필드 이름 | 크기(바이트) | 설명 |
| :----: | :----: | :---- |
| HRD | 2 | 하드웨어 유형: 이 필드는 ARP 메시지를 전송한느 로컬 네트워크에서 사용하는 하드웨어 유형을 지정하며, 더불어 사용하는 주소지정 방식도 규정한다. |
| PRO | 2 | 프로토콜 유형: 이 필드는 하드웨어 유형 필드를 보완하며 메시지에서 사용하는 3계층 주소의 유형을 지정한다 |
| HLN | 1 | 하드웨어 주소 길이: 이 메시지에 포함된 하드웨어 (2계층) 주소 길이를 바이트 단위로 지정한다. (6)|
| PLN | 1 | 프로토콜 주소 길이: 이 메시지에 포함된 프로토콜 (3계층) 주소 길이를 바이트 단위로 지정한다. (4)|
| OP | 2 | 동작 코: 이 필드는 전송중인 ARP 메시지의 본질을 지정한다. 일반 ARP에는 1과 2 값이 쓰인다. 그 밖에 ARP 프레임 포멧을 사용하는 기타 프로토콜을 지원하기 위한 여러 다른 값이 정의되어 있다. |
| SHA | 가변적 HLN 필드 값과 동일 | 송신자 하드웨어 주소 |
| SPA | 가변적 PLN 필드 값과 동일 | 송신자 프로토콜 주소 |
| THA | 가변적 HLN 필드 값과 동일 | 수신자 하드웨어 주소 |
| TPA | 가변적 PLN 필드 값과 동일 | 수신자 프로토콜 주소 |

| HRD 값 | 하드웨어 유형 |  
| :----: | :---- |
| 1 | 이더넷 (10Mb) |
| 6 | IEEE 802 네트워크 |
| 7 | ARCNeT|
| 15 | 프레임 중계(릴레이) |
| 16 | 비동기 전송 방식 (ATM) |
| 17 | HDLC |
| 18 | 파이버 채널 (Ribre Channel) |
| 19 | 비동기 전송 방식|
| 20 | 직렬 회선 |

| 동작 코드 | ARP 메시지 유형 |  
| :----: | :---- |
| 1 | ARP 요청 |
| 2 | ARP 응답 |
| 3 | RARP 요청 |
| 4 | RARP 응답 |
| 5 | DRARP 요청 |
| 6 | DRARP 응답 |
| 7 | DRARP 에러 |
| 8 | InARP 요청 |
| 9 | InARP 응답 |

![Address Resolution Protocol (ARP) Message Format!](http://www.tcpipguide.com/free/diagrams/arpformat.png "ARP 메시지 포맷")