# 주소 결정과 TCP/IP 주소 결정 프로토콜

네트워킹 프로토콜 스택을 가지고 있는 모든 장비는 2계층 주소와 3계층 주소 모두를 갖는다는 것을 의미한다.  
그래서 이들 주소를 서로 연결할 방법을 정의 하는 것은 매우 중요하다.  
이것은 네트워크 주소를 가지고 그에 해당하는 데이터 링크 계층 주소를 찾는 과정으로 이뤄지는데 이것을 주소 결정이라고 한다.  

1. TCP/IP 주소 결정 프로토콜을 자세히 설명한다.  
    1-1. 주소결정 프로토콜 (ARP)  
    1-2. 역순 주소 결정 프로토콜 (RARP)  
2. 주소 결정이 IP의 의 멀티캐스트 주소에서 어떻게 일어나는지 살펴본다.

## 주소 결정의 필요성

개념적으로 클라이언트와 서버가 3계층(IP)으로 직접 연결돼 있다 하더라도 실제로 그들이 주고 받는 정보는 여러 2계층(MAC) 링크를 통해 전송된다.
논리적으로 이 연결은 클라이언트와 서버 간에 직접 맺어질 수 있다. 하지만 사실 이 연결은 2계층 물리 링크 연결의 연속이다. 아래 그림에서 그러한 링크가 6개 있으며 그들의 대부분은 클라이언트와 서버 사이에 있는 라우터 간의 연결이다. 각 단계에서 데이터를 어디로 보낼지는 3계층 주소에 근거하여 결정되지만 실제 전송은 다음 경로에 있는 수신자의 2계층 주소를 통해 수행된다.  
![Why Address Resolution Is necessary!](http://www.tcpipguide.com/free/diagrams/arpresolutionneed.png)

근본적인 문제는 IP 주소가 네트워크의 물리적 하드웨어보다 너무 높은 수준에 있다는 것이다. 하드웨어는 IP 주소를 이해하지 못한다.
사용자의 요청이 목적지 서버가 연결된 라우터에 도달하면 그 라우터는 목적지 서버의 IP 주소를 볼 수 있다. 그렇지만 그것은 실제로 요청을 전달하는데 도움이 되지 못한다. 라우터는 서버의 MAC 주소로 요청을 보내야 하기 때문이다.
통신은 IP 계층에서 논리적으로 일어나지만 실제로는 데이터 링크 계층에서 수행 되어야 한다. 이것은 이들 두 계층의 주소를 변환하는 방법을 알아야 한다는 것을 의미한다. 그 절차를 주소 결정이라 부른다.  

> 주소 결정이 필요한 이유는 장비들이 논리적으로 3계층 주소로 통신하지만, 실제 물리적 통신을 2계층(하드웨어) 주소를 통해 수행하기 때문이다.

### 주소 결정 방법

- 직접 매핑
- 동적 매핑

#### 직접 매핑의 동작 방식

상위 계층 주소를 하위 계층 주소로 매핑한다.
예를 들면 2계층 하드웨어 주소 크기가 작다면 하드웨어 주소를 3계층 주소의 일부에 직접 정의패서 매핑하는 방식이다.  
![Address Resolution Through Direct Mapping!](http://www.tcpipguide.com/free/diagrams/arpdirectmapping.png)

#### 직접 매핑의 문제점

하드웨어 계층의 주소가 네트워크 계층 주소로 표현할 수 있을 때만 가능하다.
IP (네트워크) 주소는 32비트 이고 MAC(하드웨어) 주소는 48비트 이기 때문에 직접 매핑이 불가능 하다.  
![Address Resolution Problems With Large Hardware Address Size!](http://www.tcpipguide.com/free/diagrams/arpdirectmappingnogo.png)

#### 동적 매핑의 동작 방식

데이터를 보내고자 하는 장비가 다른 장비의 하드웨어 정보를 받고 싶다는 요청을 3계층 (네트워크) 주소 정보를 담아 브로드 캐스트 하면 본인의 3계층 (네트워크) 주소가 일치하는 장비가 응답을 보내는 방식이다. 단지 직접 매핑은 빠른 속도로 이뤄 지지만 동적 매핑은 네트워크로 메시지를 주고 받기 위해 프로토콜을 사용해야 한다.  
![Dynamic Address Resolution!](http://www.tcpipguide.com/free/diagrams/arpdynamic.png)

## TCP/IP 주소 결정 프로토콜 (ARP)

> IP 주소에 해당하는 데이터 링크 계층 주소(MAC)를 파악하는데 쓰이는 동적 결정 프로토콜  
> RFC 826 - 이더넷 주소 결정 프로토콜

이장에서 설명하는 주소 결정 프로토콜은 IPv4의 유니캐스트 주소를 변한하는데 쓰임
IPv6은 ARP 대신 주변 탐색 프로토콜을 사용한다.

### ARP 메시지 유형과 주소 표시

- 요청: 초기 요청에는 송신자는 출발지(전송할 IP 데이터 그램을 가지고 있는 장비) 장비 이고 수신자는 목적지 장비이다.
- 응답: ARP 요청에 대한 응답에서 송신자는 목적지 장비다. 그 응답은 출발지 장비에게 정송되며 그 장비가 수신자가 된다.  
모든 ARP의 메시지에서 두 장비는 서로 연관시켜야 할 두 주소(2계층과 3계층 주소)를 가지고 있다. 각 메시지에서 사용되는 4개의 서로 다른 주소는 다음과 같다.
- 송신자 하드웨어 주소: ARP 메시지 송신자의 2계층(MAC) 주소
- 송신자 프로토콜 주소: ARP 메시지 송신자의 3계층(IP) 주소
- 수신자 하드웨어 주소: ARP 메시지 송신자의 2계층(MAC) 주소
- 수신자 프로토콜 주소: ARP 메시지 송신자의 3계층(IP) 주소  
이들 주소는 각각 ARP 메시지 포맷에서 특정 위치를 차지한다.

### ARP 일반 동작

1. 출발지 장비가 캐시를 검사
2. 출발지 장비가 ARP 요청 메시지를 생성
3. 출발지 장비가 ARP 요청 메시지를 브로드캐스트
4. 로컬 장비들이 ARP 요청 메시지를 처리
5. 목적지 장비가 ARP 응답 메시지를 생성
6. 목적지 장비가 ARP 캐시를 갱신
7. 목적지 장비가 ARP 응답 메시지를 보냄
8. 출발지 장비가 ARP 응답 메시지를 처리
9. 출발지 장비가ARP 캐시를 갱신
![Address Resolution Protocol (ARP) Transaction Process!](http://www.tcpipguide.com/free/diagrams/arpoperation.png)

### ARP 메시지 포맷

| 필드 이름 | 크기(바이트) | 설명 |
| :----: | :----: | :---- |
| HRD | 2 | 하드웨어 유형: 이 필드는 ARP 메시지를 전송한느 로컬 네트워크에서 사용하는 하드웨어 유형을 지정하며, 더불어 사용하는 주소지정 방식도 규정한다. |
| PRO | 2 | 프로토콜 유형: 이 필드는 하드웨어 유형 필드를 보완하며 메시지에서 사용하는 3계층 주소의 유형을 지정한다 |
| HLN | 1 | 하드웨어 주소 길이: 이 메시지에 포함된 하드웨어 (2계층) 주소 길이를 바이트 단위로 지정한다. (6)|
| PLN | 1 | 프로토콜 주소 길이: 이 메시지에 포함된 프로토콜 (3계층) 주소 길이를 바이트 단위로 지정한다. (4)|
| OP | 2 | 동작 코: 이 필드는 전송중인 ARP 메시지의 본질을 지정한다. 일반 ARP에는 1과 2 값이 쓰인다. 그 밖에 ARP 프레임 포멧을 사용하는 기타 프로토콜을 지원하기 위한 여러 다른 값이 정의되어 있다. |
| SHA | 가변적 HLN 필드 값과 동일 | 송신자 하드웨어 주소 |
| SPA | 가변적 PLN 필드 값과 동일 | 송신자 프로토콜 주소 |
| THA | 가변적 HLN 필드 값과 동일 | 수신자 하드웨어 주소 |
| TPA | 가변적 PLN 필드 값과 동일 | 수신자 프로토콜 주소 |

| HRD 값 | 하드웨어 유형 |  
| :----: | :---- |
| 1 | 이더넷 (10Mb) |
| 6 | IEEE 802 네트워크 |
| 7 | ARCNeT|
| 15 | 프레임 중계(릴레이) |
| 16 | 비동기 전송 방식 (ATM) |
| 17 | HDLC |
| 18 | 파이버 채널 (Ribre Channel) |
| 19 | 비동기 전송 방식|
| 20 | 직렬 회선 |

| 동작 코드 | ARP 메시지 유형 |  
| :----: | :---- |
| 1 | ARP 요청 |
| 2 | ARP 응답 |
| 3 | RARP 요청 |
| 4 | RARP 응답 |
| 5 | DRARP 요청 |
| 6 | DRARP 응답 |
| 7 | DRARP 에러 |
| 8 | InARP 요청 |
| 9 | InARP 응답 |

![Address Resolution Protocol (ARP) Message Format!](http://www.tcpipguide.com/free/diagrams/arpformat.png "ARP 메시지 포맷")

### ARP 캐싱

ARP는 동적 결정 프로토콜 이기 때문에 모든 결정 과정에서 네트워크를 통해 메시지를 주고 받아야 한다.  
장비는 ARP 메시지를 보낼 때마다 로컬 네트워크를 점유하고, 네트워크 대역폭을 소모하기 때문에 다른 트래픽이 그 대역폭을 사용할 수 없다. ARP 메시지가 크지는 않지만, 모든 IP 데이터그램의 모든 홉에서 메시질르 보내는 것은 네트워크에 상당한 부하를 줄 수 있다. 그리고 그렇게 하는 것은 단순한 직접 매핑에 비해 시간 낭비가 심하다. 게다가
ARP 요청 메시지는 브로드캐스트 되기 때문에 로컬 네트워크의 모든 장비가 그 내용을 조사하느라 CPU 시간을 소모한다.
동적 결정의 효율성 문제에 대한 일반적인 해결책이 캐싱이고 처음부터 캐싱 기능을 고려해 설계됐다.  

ARP 캐시는 대응하는 하드웨어 주소와 IP 주소 집합을 포함하는 테이블 형태를 띈다.  

- 정적 ARP 캐시 항목: 수동으로 추가되고 만료 기간 없이 영구히 캐시에 남아있다.
- 동적 ARP 캐시 항목: 과거에 성공한 ARP 주소 결정의 결과로 소프트웨어 자체에서 캐시에 추가한다. 이들은 일정기간 캐시에 남아 있다가 제거 된다.

> 2가지 방식은 각각 장단점이 있지만 대부분의 경우 동적 항목이 쓰인다. 그 이유는 관리자가 개입할 필요 없이 자동관리가 되기 때문이다.  

### 프록시 ARP

> ARP는 주소 결정을 위해 브로드캐스트를 사용하는데 브로드캐스트는 다른 물리 네트워크로 전파되지 않기 때문에 서로 다른 물리 네트워크에 있는 장비들은 ARP 메시지를 주고 받을 수 없다. 그러한 상황에서 라우터와 같은 장비를 ARP 프로시로 설정하면 프로시가 다른 네트워크에 있는 장비 대신 ARP 요청에 응당하도록 할 수 있다.  

![ARP Proxy Operation!](http://www.tcpipguide.com/free/diagrams/arpproxy.png)  

ARP 프록시의 장점은 서로 다른 물리 네트워크 세그먼트에 있는 호스트에게 투명하게 작업이 일어난다는 것이다.
단점은 아래와 같다.

- 프록싱으로 인해 네트워크가 복잡해 진다.
- 하나 이상의 라우터가 동일한 네트워크 ID를 사용하는 두 물리 네트워크를 연결할 경우에 문제가 발생할 수 있다.
- 잠재적인 보안 위험을 발생시킨다. 프록싱은 본질적으로 라우터가 다른 장비인 것처럼 가장하는 것이기 때문에 한 장비가 다른 장비인 것처럼 속일 수 있는 환경이 마련됐다고 볼 수 있다.

이러한 이유로, 가능하면 물리 네트워크 간에 라우팅이 일어나도록 네트워크를 재 설계 하는게 좋다.  

### IP 멀티캐스트 주소의 TCP/IP 주소 결정

### IP 버전 6의 TCP/IP 주소 결정