# IP 네트워크 주소 변환 (NAT) 프로토콜

## 배경과 개념

NAT(Network Address Trasnlation) 는 적은 수의 공용 IP를 사설 주소를 사용하는 여러 호스트가 공유할 수 있도록 한다.

### NAT개발의 배경과 해결해야 할 문제

- 주소 공간 고갈: IP주소가 32비트만을 사용하다 보니 문제가 발생했다.
- IP 주소 비용 증가: IP 주소가 고갈되다 보니 비용이 증가한다.
- 보안 우려의 증가: 인터넷에 직접 연결 할 수록 보안 위험에 노출되었다.

### 해결방안

회사 네트워를 인터넷에 직접 연결하는 것이 아니라 간접적으로 연결하는 시스템을 구성하는 것이다.
당시에 대부분의 기관은 아래와 같은 방법으로 인터넷을 사용했다.

- 대부분의 호스트는 클라이언트 장비다.
- 동시에 인터넷에 접근하는 호스트는 많지 않다.
- 인터넷 통신은 라우팅 된다.

![전화 교환원!](https://cloudfront-us-east-1.images.arcpublishing.com/infobae/FRV3XSDUYBEFTPAWMTLNKN5SVU.jpg)

### NAT 동작 방식

NAT의 기본 구현은 기관의 내부 네트워크를 로컬 IP 네트워크를 위한 사설 주소 영역 중 하나로 설정하는 것을 포함한다. 그리고 하나 이상의 공인(인터넷) 주소가 기관에 할당되며, 하나 이상의 NAT 지원 라우터가 로컬 네트워크와 공중 인터넷 사이에 설치된다.

- 사설 IP 주소: 전화 시스템의 내선 번호
- 공인 IP 주소: 전화 시스템의 외부 회선
- NAT 라우터: 전화 시스템 컴퓨터와 상담원 역활

사실 IP 주소(내선 번호)를 필요에 따라 공인 IP 주소(외부 회선)으로 연결 시키는 것이 NAT의 동작 방식이다.

### NAT 장점

- 공인 IP 주소 공유: 대량의 호스트(장비)가 소수의 공인 IP를 공유할 수 있다.
- 쉬운 확장: 로컬 네트워크 장비는 사설 주소를 이용하고 공인 IP 주소를 필요로 하지 않기 때문에, 로컬 네트워크에 새 장비를 추가하는 것이 쉽다.
- 로컬 통제력 강화: 사설 네트워크이기 때문에 관리자는 통제력을 강화할 수 있고, 인터넷에도 연결이 가능하다.
- 인터넷 서비스 제공자 선택의 유연성: 기관에서 ISP를 변경하는 것이 용이하다. 왜냐하면 공인 주소만 바꾸면 되기 때문이다. 즉 네트워크 머신의 주소를 다시 부여할 필요가 없다.
- 보안 강화: NAT 변환은 하나의 간접 계층을 추가하는 것으로 볼 수 있다. NAT는 기관의 네트워크와 공중 인터넷 사이에 일종의 방화벽을 자동으로 생성한다. 내부 클라이언트는 공인 IP 주소를 가지고 있지 않기 때문에 외부의 악성 공격자가 클라이언트 장비를 직접 접근하는 것이 어렵다.
- 투명함: NAT 구현은 주소 변환이 하나 혹은 소수의 라우터에서만 일어나기 때문에 대부분 투명하다. 수십 혹은 수백 대의 내부 호스트는 기존의 동작을 바꿀 필요가 없다.

### NAT 단점

- 복잡성: NAT 네트워크를 구성하고 관리하는데 있어 하나의 추가적인 시스템이기 때문에 관리의 복잡성을 가중시킨다.
- 공인 주소 부족으로 인한 문제: 클라이언트 호스트 머신에 공인 IP 주소가 없기 때문에 애플리케이션 기능을 사용하지 못할 수 있다.
- 특정 애플리케이션과의 호환성 문제: NAT는 데이터그램의 IP헤더 필드만 수정하고, 애플리케이션 데이터 영역은 수정하지 않기 때문에 특정 애플리케이션에서 호환성 문제가 발생할 수 있다.
- 보안 프로토콜 문제: IPSec와 같은 프로토콜은 헤더의 변조를 탐지하도록 설계됐기 때문에 NAT에 의한 변경과 악성 프로그램 해킹을 잘 구분하지 못한다. NAT와 IPSec를 결합하는 것이 가능하지만 매우 복잡하다.
- 클라이언트 접근 지원 미비: 각 클라이언트에 공인 IP 주소가 없다는 것은 양날의 검이다. 이것은 해커로부터 호스트를 보호하지만 로컬 네트워크의 클라이언트로 정당하게 접근하는 것도 어렵게 한다.
- 성능 감소: 데이터그램이 사설 네트워크와 인터넷을 오갈 때마다 주소 변환이 필요하다.

> 많은 기관은 NAT가 단점보다 장점이 많다고 판단한다. 특히 인터넷을 클라이언트/서버방식으로 사용하는 경우에 그러하다.
> 그래서 NAT는 매우 널리 쓰이게 됐다. NAT를 개발한 주요 동기는 주소 공간의 고갈 문제 였다는 것을 기억하자.

## IP NAT 주소 용어

- 내부 주소: 기관의 사설 네트워크에서 NAT를 사용하는 장비는 내부 네트워크에 위치해 있다고 표현한다. 로컬 네트워크의 장비를 가리키는 모든 주소를 내부 주소라고 부른다.
- 외부 주소: 공중 인터넷 - 즉 로컬 네트워크 외부에 있는 모든 것 - 은 외부 네트워크에 있다고 간주한다. 공중 네트워크에 있는 장비를 가리키는 주소를 외부 주소라고  부른다.

> NAT에서 내부와 외부라는 용어는 <ins>**장비의 위치를 식별**</ins>하는데 쓰인다. 내부 주소는 기관의 사설 네트워크 내에 있는 장비의 주소를 가리킨다. 외부 주소는 공중 인터넷 장비의 주소를 가리킨다.

내부 장비는 항상 내부 주소를 가지고 있고, 외부 장비는 항상 외부 주소를 가지고 있다. 하지만 내부 또는 외부 장비의 주소는 데이터그램이 나타나는 네트워크의 위치에 따라 두 가지 서로 다른 방법으로 참조될 수 있다.

- 로컬 주소: 내부 또는 외부 주소를 가리키는가에 관계 없이 내부 네트워크의 데이터그램에 나타나는 주소를 의미한다.
- 전역 주소: 내부 또는 외부 주소를 가리키는가에 관계 없이 외부 네트워크의 데이터그램에 나타나는 주소를 의미한다.

> NAT에서 로컬과 전역은 <ins>**특정 주소가 어떤 네트워크에서 나타나는 것**</ins>을 가리키는데 쓰인다. 로컬 주소는 기관의 사설 네트워크 내에서 쓰인다. (내부 장비를 가리키든 외부 장비를 가리키든 관계 없다.) 전역 주소는 공중 인터넷에서 쓰인다. (네브 장비를 가리키든 외부 장비를 가리키든 관계 없다.)

- **내부 로컬 주소**: 로컬 네트워크에서 장비 주소로 일반적인 로컬 장비 주소 지정 방법으로 표현된다. 예를 들어 10.0.0.0 사설 블록을 사용하여 네트워크의 클라이언트에 10.0.0.207 이라는 주소를 할당 했다면 이것은 내부 로컬 주소다.
- **내부 전역 주소**: 이것은 <ins>**전역의 공중 네트워크에서 라우팅 가능한 IP 주소로 내부 장비를 외부 세계에 표한하는데 쓰인다.**</ins> NAT 구성에서, 내부 전역 주소는 NAT 라우터에서 사용할 수 있도록 기관에 할당된 공인 IP 주소를 의미한다. 예를 들어 10.0.0.207 장비가 IP주소 204.51.16.12를 갖는 인터넷 서버에 http 요청을 보내고 싶다고 하자.
  - 이 장비는 10.0.0.207을 출발지 주소로 사용한 데이터그램을 만든다. 그렇지만 이 데이터 그램을 그대로 인터넷에 보낼 경우 서버는 응답을 보낼 수가 없다. 왜냐하면 10.0.0.207은 공중 네트워크에서 라우팅 가능한 IP주소가 아니기 때문이다.
  - 그래서 NAT 라우터는 데이터그램의 10.0.0.207을 기관의 공인 IP 주소 중 하나로(여기서는 194.54.21.10 이라고 하자) 변환한다. 이 194.54.21.10이 10.0.0.207에 대응되는 내부 전역 주소다. 이 주소는 서버가 http 응답을 보낼 때 목적지 주소로 쓰일 수 있다.
  - <font color=red>내부 장비를 외부 네트워크에 표현하기 위해 변환된 주소이다.</font>
- **외부 전역 주소**: 공중 인터넷에서 참조하는 외부(공중 인터넷) 장비의 주소다. 이것은 기본적으로 인터넷의 일반적인 공인 IP주소를 의미한다.
- **외부 로컬 주소**: 로컬 네트워크에서 참조하는 외부 장비의 주소. 일부 상황에서 이것은 해당 외부 장비의 전역 주소와 동일할 수 있다.
  - <font color=red>외부 장비를 내부 네트워크에 표현하기 위해 변환된 주소이다.</font>

> 내부 로컬 주소 > 내부 전역 주소로 변환 된다  
> 외부 로컬 주소 > 외부 전역 주소로 변환 된다

[그림 28-1 IP 네트워크 주소 변환(NAT) 용어]

## IP NAT 정적 주소 매핑과 동적 주소 매핑

라우터의 NAT 소프트웨어는 변환 방법을 지시하는 변환 테이블을 관리해야 한다. 변환 테이블에 항목을 추가하는 두 가지 기본적인 방법이 존대한다.

### 정적 매핑

- 내부 또는 외부 장비의 전역 표현과 로컬 표현 사이에 정의된 영구적이고, 고정된 관계를 의미한다. 예를 들어 내부 로컬 주소가 10.0.0.207인 내부 장비가 항상 내부 전역 주소로 194.54.21.10을 사용하게 할 때 정적 매핑을 사용한다. 10.0.0.207이 인터넷에 연결을 할 때마다 NAT라우터는 그 주소를 194.54.21.10으로 바꿀것이다.
- 정잭 매핑은 영구적이므로 외부 네트워크에 항상 동일한 공인 주소로 표현되어야 할 장비에 적합하다. 이 매핑은 특정 장비로의 인바운드 트래픽을 허용하는데 쓰일 수도 있다. 즉 공중 네트워크에서 시작된 연결이 내부 네트워크의 특정 서버로 들어오도록 하는데 쓰일 수 있다. 그렇지만 이것은 수동으로 매핑 정보를 입력하고 관리해야 하며, 내부 네트워크에서 IP 공유를 허용하지 않는다는 단점이 있다.

### 동적 매핑

- 전역과 로컬 주소 표현은 NAT 라우터에서 <ins>필요할 때 마다</ins> 즉시 생성되며 사용이 끝나면 버려진다. 이것은 특히 <font color=orange>다수의 내부 장비가 전역 주소 풀(pool)을 이용</font>할 때 많이 쓰인다.  
예를 들어 동적 매핑에서 194.54.21.1 에서 194.54.21.20에 이르는 내부 전역 주소 풀을 사용한다고 하자. 10.0.0.207 장비가 인터넷에 요청을 하면, NAT 라우터는 그 요청 데이터그램의 출발지 주소를 자동으로 194.54.21.10으로 변경하지 않는다. 대신 NAT 라우터는 풀에 있는 20개의 주소 중 하나를 선택한다. 그리고 출발지 주소를 변경하여 요청을 보낸 뒤 그 주소로 오는 응답을 감시하고 응답이 올 경우 목적지 주소를 10.0.0.207로 변환한다. 세션이 완료되면 그 변환 정보는 버려지고 사용된 내부 전역 주소는 다시 풀로 반환된다.
- 동적 매핑은 대부분 NAT구현의 주요 목적인 일반 클라이언트의 공인 IP주소 공유를 촉진하기 위해 쓰이는 경우가 많다.

## IP NAT 단방향(전통적/아웃바운드) 동작

단방향 NAT에서 외부로 나가는 데이터그램은 출발지 주소가 변환되고 내부로 들어 오는 데이터그램은 목적지 주소가 변환된다. 전통적 NAT는 오직 이러한 유형의 아웃바운드 트랜잭션만을 지원한다. 그래서 공중 인터넷에서 내부 사설 IP를 갖는 서버로 요청을 보내는 경우를 처리하지 못한다.
[그럼 28-2]

## IP NAT 양방향(Two-Way/인바운드) 동작

전통적 NAT는 오직 아웃바운드 트랜잭션만을 처리하도록 설계됐다. 즉 로컬 네트워크의 클라이언트가 요청을 보내고 인터넷 장비는 응답을 보내는 상황만을 다뤘다. 그렇지만 때때로 우리는 그 반대 방향의 동작을 원할 때가 있다. 즉 우리는 외부 네트워크 장비가 내부 네트워크 장비로 트랜잭션을 시작하기를 원할 수 있다. 이러한 NAT를 <ins>양방향 NAT</ins> 또는 <ins>인바운드 NAT</ins>라고 부른다.

인바운드 상황을 생각해보자. 외부 네트워크 장비 B가 NAT를 이용해 로컬 네트워크 장비 A에게 데이터 그램을 보내고자 한다. 장비 B는 장비 A의 사설 (내부 로컬) 주소로 데이터그램을 보낼 수 없다. 그 대신 장비 A의 내부 전역 주소를 알아야 한다. 그렇지만 장비 A의 NAT 라우터는 장비 B와 가까이 있지 않다. 사실 장비 B는 장비 A의 NAT라우터가 무엇인지 모를 수도 있다.
이 문제의 해결은은 두 가지다.  

1. 외부에서 접근해야 하는 내부 네트워크의 서버와 같은 장비를 위한 정적 매핑을 사용하는 것이다. 정적 매핑을 사용할 경우에는 내부 장비의 전역 주소를 외부에 알릴 수 있기 때문에 문제를 해결할 수 있다.
2. DNS를 사용하는 것이다. DNS는 요청을 IP주소가 아닌 이름을 이용하여 보낼 수 있도록 한다. DNS서버는 이러한 이름을 해당 주소로 변환한다. DNS와 NAT는 서로 통합 될 수 있다.
  - 외부 장비에 접근하고자 하는 내부 네트워크 장비의 이름을 이용해 DNS 요청을 전송한다. 예를 들어 그 이름을 www.ilikenat.com 이라고 하자.
  - 내부 네트워크를 위한 DNS 서버는 www.ilinekat.com 이름을 해당 장비의 내부 로컬 주소로 변환한다.
  - 이 내부 로컬 주소는 NAT로 전달되며 NAT는 이것을 이용해 외부에서 접근하고자 하는 서버의 내부 로컬 주소와 내부 전역 주소를 매핑한다. 이 매핑 정보는 NAT 라우터의 변환 테이블에 저장된다.
  - DNS 서버는 외부 장비에게 응답할 때 내부 장비의 내부 로컬 (사설) 주소가 아니라 이전 단계에서 매핑한 내부 전역(공인) 주소를 알려준다.

외부 장비 204.51.16.12가 내부 장비 10.0.0.207 서버에 요청을 보내는 경우, 그리고 정적 매핑 또는 DNS를 사용해서 외부 서버가 10.0.0.27 내부 전역 주소 194.54.21.6으로 접근할 수 있다고 하자.
  [그럼 28-3 양방향 NAT 동작]

## IP NAT 포트 기반(과부하) 동작

사설 네트워크 장비의 내부 로컬 주소와 그 장비의 외부 네트워크 주소를 나타내는 내부 전역 주소 간에 매칭되어 있을 때 내부 전역 주소는 갯수가 한정적이라 사용하지 못하는 상황이 올 수 있다. 이 상황을 해결 하는데 도움을 줄 수 있는 방법이 TCP/IP에 내장돼 있다. 두 TCP/IP 전송 계층 프로토콜인 TCP와 UDP는 <font color=orange>포트</font>라는 추가 주소 지정 구성 요소를 이용한다. 메시지의 포트 번호는 두 주소 간에 개별 연결을 식별하는데 도움을 준다. 포트 번호는 TCP/IP 클라이언트와 서버의 서로 다른 여러 애플리케이션이 간섭 없이 동시에 통신 할 수 있도록 한다. 주소와 포트 조합은 유일하게 연결을 식별한다.  
이것은 다수의 내부 로컬 주소가 하나의 내부 전역 주소를 공유하는 기술이기 때문에 내부 전역 주소 과부하 또는 <ins>과부하 NAT</ins> (overloaded NAT) 라고 불린다. 또는 <ins>포트 기반 NAT</ins>, <ins>네트워크 주소 포트 변환</ins>, <ins>포트 주소 변환</ins> 이라고 불린다.

> 포트 기반 NAT는 일반 NAT의 개선된 버전으로 사설 네트워크의 다수의 호스트가 동시에 하나의 내부 전역 주소를 공유할 수 있도록 한다. 이것은 TCP와 UDP 메시지에서 사용하는 포트 번호를 변경하는 방식으로 동작한다.

포트 기반 NAT의 단점은 구현이 복잡하고, 호환성 문제 (FTP와 같은 애플리케이션에서)가 발생할 가능성이 더 크다는 것이다. 왜냐하면 단순히 IP 주소뿐만 아니라 상위 계층의 포트 번호까지 검사해야 하기 때문이다.

[그럼 28-4 포트 기반 NAT 동작]

## IP NAT 중복/2회 NAT 동작
앞에 3가지 방법은 사설 네트워크 주소와 공중 인터넷 주소를 구분해서 사용하기 때문에 내부 네트워크와 외부 네트워크의 주소 공간이 중복이 없다. 공인 주소가 될 수 없는 IP를 내부 네트워크에서 사용했으므로 NAT 라우터는 IP 주소만 보고 내트네트워크인지 아닌지를 쉽게 파악 할 수 있다. 그렇지만 내부 네트워크에서 사용하는 주소와 외부 네트워크에서 사용하는 주소가 겹칠 경우가 있다. 아래와 같은 경우

- 사설 네트워크와 사설 네트워크 간의 연결
- 사설 네트워크에 공인 주소를 부적절하게 할당
- 공인 주소 항당의 유효기간 만료

이러한 상황의 공통점은 사설 네트워크에서 쓰이는 내부 주소가 공중 네트워크의 주소와 중복된다는 것이다. 데이터그램이 로컬 네트워크로부터 송신괸 때, NAT 라우터는 데이터그램의 목적지가 내부 네트워크인지 외부 네트워크인지 구별하지 못한다.

지금까지의 살펴본 NAT는 데이터그램이 내부에서 외부로, 외부에서 내부로 전달될 때 출발지 주소 또는 목적지 주소를 변경했다. 하자만 중복 주소를 다루기 위해서는 내부에서 외부로 또는 외부에서 내부로 데이터그램이 이동할 때 <font color=orange>출발지 주소와 목적지 주소 모두를 변경해야 한다.</font> 이 기술은 해결하는 문제의 이름을 따서  <ins>중복 NAT</ins> or <ins>2회 NAT(Twice NAT)</ins> 라고 불린다.

2회 NAT는 DNS에 의존한다. 예제를 통해 알아 본다.

우리의 네트워크에 사설 주소 블록인 10.0.0.0이 아닌 MIT에서 사용하는 18.0.0.0 주소 블록을 부적절하게 할당했다고 하자. 사설 네트워크에 있는 클라이언트 중 하나인 18.0.0.18은 MIT 서버인 www,twicenat.mit.edu(주소가 18.1.2.3 임)에 요청을 보내고자 한다.
이 클라이언트는 단순히 목적지를 18.1.2.3으로 설정한 데이터그램을 보내는 것만으로는 원하는 목적을 이룰 수 없다. 왜냐하면 라우터가 그 데이터그램이 로컬 네트워크로 가는 것으로 판단하고 라우팅을 하지 않을 것이기 때문이다. 그 대신 클라이언트 18.0.0.18은 외부 장비의 주소를 얻기 위해 DNS와 NAT를 함께 사용한다.

1. 로컬 네트워크의 클라이언트(18.0.0.18)는 www.twicenat.mit.edu의 주소를 얻기 위해 DNS 요청을 송신한다.
2. 로컬 네트워크를 관장하는 2회 NAT 라우터는 이 DNS 요청을 가로챈다. 그리고 이 외부 장비를 위한 특수 매핑을 찾기 위해 테이블을 참조한다. 이 테이블에 www.twicenat.mit.edu를 주소 172.16.44.55 로 변환하라는 항목이 있다고 하자. 이것은 라우팅 불가능한 사설 RFC 1918 주소다.
3. NAT 라우터는 이 값(172.16.44.55)을 클라이언트에게 전달하면 클라이언트는 그것을 목적지 주소로 사용한다.
<ins>목적지 주소를 얻은 클라이언트는 예전과 동일한 방식(기존 NAT)과 동일한 방식으로 트랜잭션을 시작한다.</ins>

[표 28-4 중복/2회 NAT의 동작]

## IP Nat 호환성 문제와 특수처리 요구사항
